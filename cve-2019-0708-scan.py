#!C:\Python27\python
#coding=utf-8

import os,io
import MySQLdb,thread,time
from multiprocessing import Process

#开始扫描
def start_scan(ip,port):
	cmd="0708detector.exe -t %s -p %s" % (ip,port)
	cmd_info=os.popen(cmd)
	cmd_info_string=cmd_info.read()
	print "ip:%s is scan over !" % (ip)
	return cmd_info_string
	
#连接数据库	
def mysql_db_conn():
	db=MySQLdb.connect("127.0.0.1","root","","cve_2019_0708")
	return db

#查询数据	
def mysql_db_select():
	db=mysql_db_conn()
	cursor = db.cursor()
	cursor.execute("select * from tb_scan ")
	data=cursor.fetchone()
	print data
	db.close()

#插入数据	
def mysql_db_insert(ip,infor):
	db=mysql_db_conn()
	sql="insert into cve_2019_0708.tb_scan(id,ip,infor,time) values(null,'%s','%s',now())" % (ip,infor)
	cursor=db.cursor()
	cursor.execute(sql)
	db.commit()
	db.close()
	
#获取ip地址
def get_ip(file):
	fp=open(file)
	ips=[]
	for line in fp.readlines():
		ips.append(line.strip("\r\n"))
	fp.close()
	return ips
	
	
	
def start_all_scan(file_name):
	ips=get_ip(file_name)
	all_ip_num=len(ips)
	i=1
	for a in ips:
		infor=start_scan(a,'3389')
		print infor
		mysql_db_insert(a,infor)
		print "*****************scaning:%s/%s***********************" % (i,all_ip_num)
		i=i+1
		if i%100==0:
			os.system("cls")

def create_ips():
	ip_list=[]
	for line in file("ip.txt",'r'):
		ip_list.append(line.split("\n"))	
	for i in ip_list:
		fp=open(i[0],"a")
		for x in xrange(1,255):
			i_temp=i[0].split(".")
			ip_temp="%s.%s.%s.%s\r\n" % (i_temp[0],i_temp[1],i_temp[2],x)
			fp.write(ip_temp)
		fp.close()

if __name__ == '__main__':
	create_ips()
	ip_list=[]
	for line in file("ip.txt",'r'):
		ip_list.append(line.split("\n"))	
	for i in ip_list:
		Process(target=start_all_scan,args=(i[0],)).start()


